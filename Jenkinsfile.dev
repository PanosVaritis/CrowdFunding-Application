pipeline {
    agent any 

    environment {
        GITHUB_TOKEN=credentials('github-token')
        GITHUB_USERNAME='panosvaritis'
        GITHUB_URL='ghcr.io'
        IMAGE_P1="${GITHUB_URL}/${GITHUB_USERNAME}/springbackend"
    }

    parameters {
        booleanParam (name: 'DEBUG', defaultValue: false, description: 'Used to show info')
    }

        stages {
            
            stage ('Welcome message'){
                steps {
                    sh """
                    echo "Hello from jenkins server"
                    """
                }
            }
            stage ('Clean workspace'){
                steps {
                    cleanWs()
                }
            }
            stage ('Checkout the code'){
                steps {
                    checkout scm
                }
            }
            stage ('DEBUG'){
                steps {
                    script{
                        if (params.DEBUG){
                            echo "Git hub username: ${GITHUB_USERNAME}"
                            echo "Git hub url: ${GITHUB_URL}"
                            echo "Token is fetched!! Lenght ${GITHUB_TOKEN.length()}"
                            echo "Image name prefix: ${IMAGE_P1}"
                        }else {
                            echo "Nothing to show"
                        }
                    }
                }
            }
            stage ('Build-Login-Push to container registry'){
                steps {
                    //Step 1: Login to container gegistry (Valid to all step block)
                    sh """
                    echo \${GITHUB_TOKEN} | docker login ${GITHUB_URL} -u ${GITHUB_USERNAME} --password-stdin
                    """
                    //Step 2: Build image
                    sh '''
                    COMMIT_HASH=$(git log --oneline | awk 'NR == 1 {print $1}')
                    echo ${COMMIT_HASH}
                    echo ${IMAGE_P1}:${COMMIT_HASH}
                    docker build -t ${IMAGE_P1}:${COMMIT_HASH} -t ${IMAGE_P1}:latest -f backend-autobuild-multistage.Dockerfile .
                    '''

                    //Step 3: Push image
                    sh """
                    docker push ${IMAGE_P1} --all-tags
                    docker logout ${GITHUB_URL}
                    """
                }
            }       
        //}
        post {
            success {
                mail to: 'panosvaritis@gmail.com',
                subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """\
Hello,

The build was successful!

Job: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Build Tag: ${BUILD_TAG}

Kind regards Panos
"""
            }
            failure {
                mail to: 'panosvaritis@gmail.com',
                subject: "FAILURE: #${BUILD_TAG}",
                body: """\
Hello user, 
Unexpected failure occured
Build tag: ${BUILD_TAG}
Commit id to check: ${GIT_COMMIT}
King regards Panos
"""
            }
        }
}
